# Ironic All‑in‑One (AIO) Container

Single‑container OpenStack Ironic (API + Conductor) for standalone bare metal provisioning via Redfish virtual media. No Keystone, no PXE/DHCP infrastructure required.

## Why This Image

- **Standalone / noauth**: Simplest possible Ironic usage.
- **Single process**: API + Conductor launched together.
- **Redfish focus**: Only Redfish hardware + virtual media boot enabled.
- **Self‑maintaining DB**: Entry point creates/updates SQLite schema automatically.
- **Deterministic releases**: GitHub tags produce immutable image tags (`vX.Y.Z`, `X.Y`, `X`).
- **Fast local testing**: Minimal runtime dependencies; just mount config + DB file.

## Image & Tags

Published to GitHub Container Registry:

```
ghcr.io/mattcburns/ironic-aio
```

Tag strategy (from `docker-publish.yml`):

- `master` (latest state of the default branch)
- `vX.Y.Z` (full semver tag you push)
- `X.Y` and `X` convenience semver tags
- Commit SHA tag (e.g. `sha-<shortsha>`) for reproducibility

Example pulls:

```bash
docker pull ghcr.io/mattcburns/ironic-aio:master
docker pull ghcr.io/mattcburns/ironic-aio:v1.2.3
docker pull ghcr.io/mattcburns/ironic-aio:1.2
```

## Quick Start (Docker Run)

1. Ensure you have a config file and an empty DB file on the host (create the DB file with `touch` to avoid Docker mounting a directory):

```bash
cp ironic.conf.example ironic.conf
touch ironic.sqlite
```

2. Run the container (maps API 6385 + local httpboot 8080):

```bash
docker run -d --name ironic \
  -p 6385:6385 -p 8080:8080 \
  -v "$PWD/ironic.conf:/app/ironic.conf:ro" \
  -v "$PWD/ironic.sqlite:/app/ironic.sqlite" \
  ghcr.io/mattcburns/ironic-aio:master
```

3. Verify:

```bash
curl http://localhost:6385/v1          # API root
docker logs -f ironic | head -n 50     # recent startup logs
docker exec ironic baremetal driver list
```

On first start the entrypoint will:

- Parse DB path from `[database]` section of `ironic.conf`
- Create schema if the file is missing or empty
- Run an upgrade if the DB already exists
- Launch `ironic` (single process API + Conductor)

## Configuration

Mount your `ironic.conf` into `/app/ironic.conf` (read‑only recommended). To apply changes:

```bash
vim ironic.conf
docker restart ironic
docker logs -f ironic | grep -i 'Loading'  # optional validation
```

Minimal relevant defaults are already set (redfish only, json-rpc transport, sqlite). Adjust hardware driver settings as needed for your environment.

## Database Handling

SQLite file lives at `/app/ironic.sqlite` (derived from `connection = sqlite:////app/ironic.sqlite`). Important points:

- Pre‑create with `touch ironic.sqlite` before `docker run` so Docker mounts a file, not a directory.
- Entry point auto upgrades schema on each start.
- To reset: stop container, remove file, recreate empty file, start again.

Reset example:

```bash
docker stop ironic
rm -f ironic.sqlite
touch ironic.sqlite
docker start ironic
```

Manual operations (rarely needed):

```bash
docker exec ironic ironic-dbsync --config-file /app/ironic.conf upgrade
docker exec ironic ironic-dbsync --config-file /app/ironic.conf create_schema
```

## Release Automation

Two GitHub Actions workflows:

1. `docker-publish.yml` – builds image on pushes, PRs, and version tags; pushes on non‑PR events.
2. `release.yml` – creates a GitHub Release for `v*` tags with autogenerated notes and usage snippet.

To cut a release:

```bash
git tag v1.2.3
git push origin v1.2.3
```

This produces image tags: `v1.2.3`, `1.2`, `1`, plus the commit SHA.

## Common Commands

```bash
# List nodes (after you create some)
curl http://localhost:6385/v1/nodes | jq

# Create a node (example, adjust driver-specific fields)
curl -X POST http://localhost:6385/v1/nodes -H 'Content-Type: application/json' \
  -d '{"driver":"redfish","name":"node01"}'

# Show enabled drivers
docker exec ironic baremetal driver list
```

## Troubleshooting

| Symptom | Cause | Fix |
+|---------|-------|-----|
+| Entry point error: "Expected SQLite database file but found a directory" | Forgot to `touch ironic.sqlite` before run | Stop container, remove directory, `touch ironic.sqlite`, re-run |
+| API not reachable on 6385 | Port not published | Include `-p 6385:6385` in run command |
+| Config changes ignored | Container caching old config | Ensure mount path is correct and restart container |

## License

No explicit license provided; treat as internal/development unless clarified.

---
Pull / report issues: `ghcr.io/mattcburns/ironic-aio`
